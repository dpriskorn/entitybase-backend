@startuml Data Flow

title Wikibase Backend - Data Flow

actor "Client" as Client
rectangle "FastAPI" as API
rectangle "Request Handler" as Handler
rectangle "Service Layer" as Service
rectangle "Vitess Client" as VitessClient
database "Vitess DB" as Vitess
rectangle "S3 Client" as S3Client
storage "S3 Terms" as S3Terms
storage "S3 Statements" as S3Statements
storage "S3 References" as S3References
storage "S3 Qualifiers" as S3Qualifiers
storage "S3 Revisions" as S3Revisions
storage "S3 Dumps" as S3Dumps
rectangle "Workers" as Workers
database "Kafka" as Kafka

' Main request flow
Client -> API : HTTP Request
API -> Handler : Route Request
Handler -> Service : Business Logic
Service -> VitessClient : Database Query
VitessClient -> Vitess : SQL Query

' Background processing
Handler -> Kafka : Change Events
Workers -> Vitess : Background Tasks

' Storage operations
Service -> S3Client : Metadata Operations
S3Client -> S3Terms : Labels/Descriptions/Aliases
Service -> S3Client : Statement Operations
S3Client -> S3Statements : Statement Deduplication
Service -> S3Client : Reference Operations
S3Client -> S3References : Reference Deduplication
Service -> S3Client : Qualifier Operations
S3Client -> S3Qualifiers : Qualifier Deduplication
Service -> S3Client : Revision Operations
S3Client -> S3Revisions : Revision Data
Workers -> S3Client : Dump Operations
S3Client -> S3Dumps : Entity Exports

' Response flow
S3Terms --> S3Client : Metadata
S3Statements --> S3Client : Statements
S3References --> S3Client : References
S3Qualifiers --> S3Client : Qualifiers
S3Revisions --> S3Client : Revisions
S3Dumps --> S3Client : Dump Data
S3Client --> Service : Retrieved Data
Vitess --> VitessClient : Results
VitessClient --> Service : Response Data
Service --> Handler : Processed Data
Handler --> API : JSON Response
API --> Client : HTTP Response

@enduml