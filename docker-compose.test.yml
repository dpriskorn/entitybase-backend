services:
  minio:
    image: minio/minio:latest
    container_name: test-minio
    restart: unless-stopped
    command: server /data --console-address ":9001"
    ports:
      - "19000:9000"
      - "19001:9001"
    environment:
      - MINIO_ROOT_USER=fakekey
      - MINIO_ROOT_PASSWORD=fakesecret
      - MINIO_DEFAULT_BUCKETS=testbucket
    volumes:
      - minio-data:/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 10s
      timeout: 5s
      retries: 5
    mem_limit: 1g
    cpus: "0.5"

  vitess:
    image: vitess/vttestserver:mysql80
    container_name: test-vitess
    environment:
      KEYSPACES: page
      NUM_SHARDS: 1
      PORT: 15306
      MYSQL_BIND_HOST: 0.0.0.0
      CHARSET: utf8mb4
      MYSQL_MAX_CONNECTIONS: 1000
      FOREIGN_KEY_MODE: allow
    ports:
      - "25309:15309"
      - "25307:15307"
    healthcheck:
      test: ["CMD", "mysql", "-h", "127.0.0.1", "-P", "15309", "-e", "select 1"]
      interval: 5s
      timeout: 3s
      retries: 20
    mem_limit: 256m
    cpus: "1.0"

  idworker:
   container_name: test-idworker
   build:
     context: .
     dockerfile: docker/containers/Dockerfile.id-generator
   environment:
     WORKER_ID: id_worker_1
     WORKER_COUNT: 1
     VITESS_HOST: test-vitess
     VITESS_PORT: 15309
     VITESS_DATABASE: page
     VITESS_USER: root
     VITESS_PASSWORD: ""
   depends_on:
     vitess:
       condition: service_healthy
   healthcheck:
     test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
     interval: 30s
     timeout: 10s
     retries: 3
     start_period: 30s
    mem_limit: "500m"
    cpus: "0.5"

  dropworker:
    container_name: test-dropworker
    build:
      context: .
      dockerfile: docker/containers/Dockerfile.drop-worker
    environment:
      VITESS_HOST: test-vitess
      VITESS_PORT: 15309
      VITESS_DATABASE: page
      VITESS_USER: root
      VITESS_PASSWORD: ""
    depends_on:
      vitess:
        condition: service_healthy
    # No ports - runs and exits after dropping tables
    mem_limit: 0.5g
    cpus: "0.5"

  create-buckets:
   container_name: test-create-buckets
   build:
     context: .
     dockerfile: docker/containers/Dockerfile.api
   environment:
     MINIO_ENDPOINT: http://minio:9000
     MINIO_ACCESS_KEY: fakekey
     MINIO_SECRET_KEY: fakesecret
     PYTHONPATH: /app/src
   depends_on:
     minio:
       condition: service_healthy
   command: python -m models.workers.dev setup
   # No ports - runs and exits after bucket setup
   mem_limit: 0.5g
   cpus: "0.5"

  api:
     build:
       context: .
       dockerfile: docker/containers/Dockerfile.api
     container_name: test-api
     ports:
       - "18000:8000"
      depends_on:
        minio:
          condition: service_healthy
        vitess:
          condition: service_healthy
        idworker:
          condition: service_healthy
        dropworker:
          condition: service_completed_successfully
        create-buckets:
          condition: service_completed_successfully
     environment:
        S3_ENDPOINT: http://minio:9000
        S3_ACCESS_KEY: fakekey
        S3_SECRET_KEY: fakesecret
        S3_BUCKET: testbucket
        VITESS_HOST: vitess
        VITESS_PORT: 15309
        VITESS_DATABASE: page
        VITESS_USER: root
        VITESS_PASSWORD: ""
        S3_REVISION_VERSION: "latest"
        S3_STATEMENT_VERSION: "latest"
        WMF_RECENTCHANGE_VERSION: "latest"
        ENABLE_STREAMING: "false"
        KAFKA_BROKERS: redpanda:9092
        KAFKA_TOPIC: wikibase.entity_change
        LOG_LEVEL: "DEBUG"
        ENVIRONMENT: "dev"
     command: uvicorn models.rest_api.main:app --host 0.0.0.0 --port 8000
     healthcheck:
       test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
       interval: 5s
       timeout: 3s
       retries: 10
       start_period: 10s
     mem_limit: 1g
     cpus: "1.0"

  test-runner:
    build:
      context: .
      dockerfile: docker/containers/Dockerfile.tests
    container_name: test-runner
    environment:
      PYTHONPATH: /app
      REST_API_URL: http://test-api:8000
    depends_on:
      api:
        condition: service_healthy
    command: PYTHONPATH=/app pytest tests/ --ignore=tests/disabled/ -q --tb=no
    networks:
      - default
    mem_limit: 1g
    cpus: "1.0"

volumes:
  minio-data: