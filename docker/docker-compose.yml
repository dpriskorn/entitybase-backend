services:
  minio:
    image: minio/minio:latest
    container_name: minio
    restart: unless-stopped
    command: server /data --console-address ":9001"
    ports:
      - "9000:9000"
      - "9001:9001"
    environment:
      - MINIO_ROOT_USER=fakekey
      - MINIO_ROOT_PASSWORD=fakesecret
      - MINIO_DEFAULT_BUCKETS=testbucket
    volumes:
      - minio-data:/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 10s
      timeout: 5s
      retries: 5
    mem_limit: "1g"
    cpus: "0.5"

  vitess:
    image: vitess/vttestserver:mysql80
    container_name: vitess
    environment:
      KEYSPACES: entitybase
      NUM_SHARDS: 1
      PORT: 15306
      MYSQL_BIND_HOST: 0.0.0.0
      CHARSET: utf8mb4
      MYSQL_MAX_CONNECTIONS: 1000
      FOREIGN_KEY_MODE: allow
    ports:
      - "15309:15309"
      - "15307:15307"
    healthcheck:
      test: ["CMD", "mysql", "-h", "127.0.0.1", "-P", "15309", "-e", "select 1"]
      interval: 5s
      timeout: 3s
      retries: 20
    mem_limit: 1500m
    cpus: "1.5"

  # Lightweight Kafka alternative for MVP
  # redpanda:
  #   image: redpandadata/redpanda:latest
  #   container_name: redpanda
  #   command:
  #     - redpanda
  #     - start
  #     - --overprovisioned
  #     - --smp 1
  #     - --memory 1G
  #     - --reserve-memory 0M
  #     - --node-id 0
  #     - --check=false
  #     - --kafka-addr PLAINTEXT://0.0.0.0:9092
  #     - --advertise-kafka-addr PLAINTEXT://redpanda:9092
  #   ports:
  #     - "9092:9092"
  #     - "9644:9644"
  #   healthcheck:
  #     test: ["CMD-SHELL", "rpk cluster health | grep -q 'Healthy'"]
  #     interval: 10s
  #     timeout: 5s
  #     retries: 5
  #     deploy:
  #        resources:
  #          limits:
  #            cpus: "1.0"
  #            memory: 1g
  #      mem_limit: 1g
  #      cpus: "1.0"

  api:
     build:
       context: ..
       dockerfile: docker/containers/Dockerfile.api
     container_name: api
     ports:
       - "8000:8000"
     depends_on:
        minio:
          condition: service_healthy
        vitess:
          condition: service_healthy
        idworker:
          condition: service_healthy
        create-buckets:
          condition: service_completed_successfully
     environment:
        S3_ENDPOINT: http://minio:9000
        S3_ACCESS_KEY: fakekey
        S3_SECRET_KEY: fakesecret
        S3_BUCKET: testbucket
        VITESS_HOST: vitess
        VITESS_PORT: 15309
        VITESS_DATABASE: entitybase
        SCHEMA_ENTITYCHANGE_VERSION: 1.0.0
        SCHEMA_ENDORSECHANGE_VERSION: 1.0.0
        SCHEMA_NEWTHANK_VERSION: 1.0.0
        VITESS_USER: root
        VITESS_PASSWORD: ""
        S3_REVISION_VERSION: "3.0.0"
        S3_STATEMENT_VERSION: "1.0.0"
        STREAMING_ENTITY_CHANGE_VERSION: "1.0.0" # WMF calls this 'recentchange'
        STREAMING_ENTITY_DIFF_VERSION: "2.0.0" # WMF calls this 'rdf_change'
        STREAMING_ENABLED: "false"
        KAFKA_BROKERS: redpanda:9092
        KAFKA_ENTITY_CHANGE_TOPIC: wikibase.entity_change
        KAFKA_ENTITY_DIFF_TOPIC: wikibase.entity_diff
        LOG_LEVEL: "DEBUG"
        ENVIRONMENT: "prod"
        USER_AGENT: "Entitybase/1.0 User:So9q"
     command: uvicorn models.rest_api.main:app --host 0.0.0.0 --port 8000
     healthcheck:
       test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
       interval: 5s
       timeout: 3s
       retries: 10
       start_period: 10s
     mem_limit: 1g
     cpus: 1

  integration:
      build:
        context: ..
        dockerfile: docker/containers/Dockerfile.tests
      container_name: integration
      depends_on:
        api:
          condition: service_healthy
      command: pytest tests/ -m integration -v -n 0 --tb=auto --log-cli-level=DEBUG --durations=10 --exitfirst
      networks:
       - default
      mem_limit: 1g
      cpus: 1

  e2e:
     build:
       context: ..
       dockerfile: docker/containers/Dockerfile.tests
     container_name: e2e
     depends_on:
       integration:
         condition: service_completed_successfully
     command: pytest -m e2e -v -n 0 --tb=long --log-cli-level=DEBUG --exitfirst
     networks:
       - default
     mem_limit: 1g
     cpus: 1

  idworker:
   container_name: idworker
   build:
     context: ..
     dockerfile: docker/containers/Dockerfile.id-generator
   environment:
     WORKER_ID: id_worker_1
     WORKER_COUNT: 1
     VITESS_HOST: vitess
     VITESS_PORT: 15309
     VITESS_DATABASE: entitybase
     VITESS_USER: root
     VITESS_PASSWORD: ""
   depends_on:
     vitess:
       condition: service_healthy
   healthcheck:
     test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
     interval: 30s
     timeout: 10s
     retries: 3
     start_period: 30s
   mem_limit: 512m
   cpus: 1

  create-buckets:
   container_name: create-buckets
   build:
     context: ..
     dockerfile: docker/containers/Dockerfile.api
   environment:
     MINIO_ENDPOINT: http://minio:9000
     MINIO_ACCESS_KEY: fakekey
     MINIO_SECRET_KEY: fakesecret
     PYTHONPATH: /app/src
   depends_on:
     minio:
       condition: service_healthy
   command: python -m models.workers.dev setup
   # No ports - runs and exits after bucket setup
   mem_limit: 512m
   cpus: 1


volumes:
  minio-data:
